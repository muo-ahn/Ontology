# ==========================================
# ğŸ§  Ontology Ã— vLM Ã— LLM Prototype
# Makefile (Local / GPU / Metal ê³µìš©)
# ==========================================

PROJECT_NAME = grounded-ai
OLLAMA_HOST = http://localhost:11434
NEO4J_URI = bolt://neo4j:7687
NEO4J_USER = neo4j
NEO4J_PASS = test1234
QDRANT_URL = http://qdrant:6333
NEO4J_SVC ?= neo4j 
IMPORT_DIR ?= /var/lib/neo4j/import
HOST_DATA    ?= ./data/medical_dummy
CYpher_FILE  ?= ./scripts/cyphers/seed.cypher
CYpher_FILE_load_all  ?= ./scripts/cyphers/load_all.cypher
CYpher_FILE_load_a  ?= ./scripts/cyphers/seed_dummy_A.cypher
CYpher_FILE_load_b  ?= ./scripts/cyphers/seed_dummy_B.cypher
CYpher_FILE_load_c  ?= ./scripts/cyphers/seed_dummy_C.cypher
CYpher_MIGRATE_IMAGE ?= ./cypher/migrate_image_id.cypher

# ------------------------------------------
# ê¸°ë³¸ ëª…ë ¹
# ------------------------------------------
.PHONY: up down rebuild logs seed pull models clean db-cp db-load migrate-image-id migrate-constraints verify-pipeline-debug

## Image.id -> image_id property migration
migrate-image-id:
	@echo "ğŸ”„ Migrating Image.id to Image.image_id..."
	@[ -f $(CYpher_MIGRATE_IMAGE) ] || { echo "âŒ $(CYpher_MIGRATE_IMAGE) not found."; exit 1; }
	@cid=$$(docker compose ps -q $(NEO4J_SVC)); \
	if [ -z "$$cid" ]; then echo "âŒ Neo4j container not running. Run 'make up' first."; exit 1; fi; \
	docker cp $(CYpher_MIGRATE_IMAGE) $$cid:/tmp/migrate_image_id.cypher; \
	docker exec -t $$cid cypher-shell -u $(NEO4J_USER) -p $(NEO4J_PASS) -f /tmp/migrate_image_id.cypher; \
	docker exec -t $$cid rm -f /tmp/migrate_image_id.cypher;

.PHONY: migrate-constraints
migrate-constraints:
	cypher-shell -u $${NEO4J_USER} -p $${NEO4J_PASS} -f cypher/migrate_constraints.cypher

## ì»¨í…Œì´ë„ˆ ê¸°ë™ (FastAPI, Neo4j, Qdrant, UI)
up:
	@echo "ğŸš€ Starting $(PROJECT_NAME) stack..."
	OLLAMA_HOST=$(OLLAMA_HOST) docker compose up -d --build

## ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
down:
	@echo "ğŸ§¹ Stopping containers..."
	docker compose down -v

## ì „ì²´ ì¬ë¹Œë“œ
rebuild: down up

## ì‹¤ì‹œê°„ ë¡œê·¸ ë³´ê¸° (APIë§Œ)
logs:
	docker compose logs -f api

## ì‹œë“œ ë°ì´í„° ì£¼ì… (Neo4j)
seed:
	@echo "ğŸŒ± Seeding Neo4j with sample Ontology..."
	@[ -f $(CYpher_FILE) ] || { echo "âŒ $(CYpher_FILE) not found. Create scripts/seed.cypher first."; exit 1; }
	@cid=$$(docker compose ps -q $(NEO4J_SVC)); \
	if [ -z "$$cid" ]; then echo "âŒ Neo4j container not running. Run 'make up' first."; exit 1; fi; \
	docker cp $(CYpher_FILE) $$cid:/tmp/seed.cypher; \
	docker exec -t $$cid cypher-shell -u $(NEO4J_USER) -p $(NEO4J_PASS) -f /tmp/seed.cypher; \
	docker exec -t $$cid rm -f /tmp/seed.cypher; \

## ë¶ˆëŸ¬ì˜¤ê¸° (Ollama ëª¨ë¸)
pull:
	@echo "â¬‡ï¸ Pulling base models from Ollama..."
# 	ollama pull qwen2:7b-instruct-q4_K_M
	ollama pull qwen2.5:7b-instruct-q4_K_M
	ollama pull qwen2.5vl:latest
	ollama pull minicpm-v:latest

## ë¡œì»¬ ëª¨ë¸ í´ë” ì¤€ë¹„
models:
	mkdir -p ./models ./data ./ui ./api

## ì •ë¦¬
clean:
	@echo "ğŸ§½ Cleaning build artifacts..."
	docker system prune -f
	rm -rf ./__pycache__ */__pycache__ .pytest_cache || true

## /pipeline/analyze ë””ë²„ê·¸ í•„ë“œ ê²€ì¦ (cURL + jq)
verify-pipeline-debug:
	@./scripts/verify_pipeline_debug.sh

# ------------------------------------------
# ìœ í‹¸ë¦¬í‹°
# ------------------------------------------

## FastAPI API í¬íŠ¸ í™•ì¸
status:
	@echo "ğŸŒ API endpoint: http://localhost:8000"
	@echo "ğŸ“Š Streamlit UI: http://localhost:8501"
	@echo "ğŸ§© Neo4j Browser: http://localhost:7474"
	@echo "ğŸ’¾ Qdrant Dashboard: http://localhost:6333/dashboard"

## Neo4j ì½˜ì†” ì ‘ì†
neo4j:
	docker exec -it $$(docker ps -qf "name=neo4j") cypher-shell -u $(NEO4J_USER) -p $(NEO4J_PASS)

## GPU ëª¨ë“œ ì‹¤í–‰ (4070 ë“±)
gpu:
	@echo "âš¡ Starting with GPU profile..."
	OLLAMA_HOST=$(OLLAMA_HOST) docker compose --profile gpu up -d --build

## CSV -> ì»¨í…Œì´ë„ˆ import/ í´ë”ë¡œ ë³µì‚¬ (docker cp + container id)
db-cp:
	@echo "ğŸ“¦ Copy CSVs into Neo4j container import dir..."
	@cid=$$(docker compose ps -q $(NEO4J_SVC)); \
	if [ -z "$$cid" ]; then echo "âŒ Neo4j container not running. Run 'make up' first."; exit 1; fi; \
	for f in patients.csv encounters.csv observations.csv diagnoses.csv medications.csv imaging.csv ai_inference.csv; do \
		echo "  - $$f"; \
		docker cp $(HOST_DATA)/$$f $$cid:$(IMPORT_DIR)/; \
	done; \
	echo "âœ… Copied all CSVs."

## Cypher ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰(íŒŒì¼ ê¸°ë°˜; docker cp + exec)
db-load:
	@echo "ğŸ§  Running Cypher LOAD CSV from $(CYpher_FILE_load_all)..."
	@[ -f $(CYpher_FILE_load_all) ] || { echo "âŒ $(CYpher_FILE_load_all) not found. Create scripts/load_all.cypher first."; exit 1; }
	@cid=$$(docker compose ps -q $(NEO4J_SVC)); \
	if [ -z "$$cid" ]; then echo "âŒ Neo4j container not running. Run 'make up' first."; exit 1; fi; \
	docker cp $(CYpher_FILE_load_all) $$cid:/tmp/load_all.cypher; \
	docker exec -t $$cid cypher-shell -u $(NEO4J_USER) -p $(NEO4J_PASS) -f /tmp/load_all.cypher; \
	docker exec -t $$cid rm -f /tmp/load_all.cypher; \
	echo "âœ… Neo4j LOAD CSV done."

## Cypher ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰(íŒŒì¼ ê¸°ë°˜; A ì„¸íŠ¸)
db-load-a:
	@echo "ğŸ§  Running Cypher LOAD CSV for Dummy Set A from $(CYpher_FILE_load_a)..."
	@[ -f $(CYpher_FILE_load_a) ] || { echo "âŒ $(CYpher_FILE_load_a) not found. Create scripts/seed_dummy_A.cypher first."; exit 1; }
	@cid=$$(docker compose ps -q $(NEO4J_SVC)); \
	if [ -z "$$cid" ]; then echo "âŒ Neo4j container not running. Run 'make up' first."; exit 1; fi; \
	docker cp $(CYpher_FILE_load_a) $$cid:/tmp/seed_dummy_A.cypher; \
	docker exec -t $$cid cypher-shell -u $(NEO4J_USER) -p $(NEO4J_PASS) -f /tmp/seed_dummy_A.cypher; \
	docker exec -t $$cid rm -f /tmp/seed_dummy_A.cypher; \
	echo "âœ… Neo4j LOAD CSV for Dummy Set A done."

## Cypher ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰(íŒŒì¼ ê¸°ë°˜; B ì„¸íŠ¸)
db-load-b:
	@echo "ğŸ§  Running Cypher LOAD CSV for Dummy Set B from $(CYpher_FILE_load_b)..."
	@[ -f $(CYpher_FILE_load_b) ] || { echo "âŒ $(CYpher_FILE_load_b) not found. Create scripts/seed_dummy_B.cypher first."; exit 1; }
	@cid=$$(docker compose ps -q $(NEO4J_SVC)); \
	if [ -z "$$cid" ]; then echo "âŒ Neo4j container not running. Run 'make up' first."; exit 1; fi; \
	docker cp $(CYpher_FILE_load_b) $$cid:/tmp/seed_dummy_B.cypher; \
	docker exec -t $$cid cypher-shell -u $(NEO4J_USER) -p $(NEO4J_PASS) -f /tmp/seed_dummy_B.cypher; \
	docker exec -t $$cid rm -f /tmp/seed_dummy_B.cypher; \
	echo "âœ… Neo4j LOAD CSV for Dummy Set B done."

## Cypher ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰(íŒŒì¼ ê¸°ë°˜; C ì„¸íŠ¸)
db-load-c:
	@echo "ğŸ§  Running Cypher LOAD CSV for Dummy Set C from $(CYpher_FILE_load_c)..."
	@[ -f $(CYpher_FILE_load_c) ] || { echo "âŒ $(CYpher_FILE_load_c) not found. Create scripts/seed_dummy_C.cypher first."; exit 1; }
	@cid=$$(docker compose ps -q $(NEO4J_SVC)); \
	if [ -z "$$cid" ]; then echo "âŒ Neo4j container not running. Run 'make up' first."; exit 1; fi; \
	docker cp $(CYpher_FILE_load_c) $$cid:/tmp/seed_dummy_C.cypher; \
	docker exec -t $$cid cypher-shell -u $(NEO4J_USER) -p $(NEO4J_PASS) -f /tmp/seed_dummy_C.cypher; \
	docker exec -t $$cid rm -f /tmp/seed_dummy_C.cypher; \
	echo "âœ… Neo4j LOAD CSV for Dummy Set C done."

# ------------------------------------------
db-delete:
	@echo "ğŸ—‘ï¸ Deleting all nodes and relationships in Neo4j..."
	@cid=$$(docker compose ps -q $(NEO4J_SVC)); \
	if [ -z "$$cid" ]; then echo "âŒ Neo4j container not running. Run 'make up' first."; exit 1; fi; \
	docker exec -t $$cid cypher-shell -u $(NEO4J_USER) -p $(NEO4J_PASS) "MATCH (n) DETACH DELETE n;"; \
	echo "âœ… Deleted all nodes and relationships."