# 미드-퓨전 멀티모달 추론 요구사항

## 기능
- 의료 이미지, 텍스트 프롬프트, 선택적 환자/내원 식별자를 입력받아 미드-퓨전 LLM/VLM 스택으로 텍스트 보고 및 그래프 업데이트를 생성한다.
- 실시간(동기)·지연(비동기) 추론 모드를 지원하고 요청 시 결합 중간 활성값과 그래프 조회 사실을 노출한다.
- 이미지 메타데이터, 결합 구성(주입 레이어, 게이팅 파라미터)과 결과 출력물을 안정적인 아이덴포턴시 키와 함께 보존한다.
- 미드-퓨전 검증 실패 시 레이트-퓨전 결과로 폴백하되 성능 저하를 명시적으로 표시한다.

## 결합 아키텍처
- VLM 비주얼 토큰을 LLM 은닉 차원으로 사영하는 공유 임베딩 인터페이스를 유지하고 런타임에서 결합 깊이(초기·중간·후기)를 구성 가능하게 한다.
- VLM 피처 추출을 재사용할 수 있도록 비주얼 토큰 캐시를 직렬화해 저장한다.
- 주의 지도, 레이어 출력 등 관측 지점을 노출해 오프라인 평가·디버깅에 활용하고 결합 설정과 함께 샘플링 파라미터(temperature, top-k)를 로깅한다.

## 그래프 통합
- LLM이 계획한 슬롯(환자, 모달리티, 의심 소견 등)을 Neo4j 조회로 매핑하는 Cypher 템플릿을 정의해 각 디코딩 단계 전에 정보를 가져온다.
- 조회된 그래프 사실을 게이트드 메모리 토큰 또는 키/값 캐시로 디코딩 루프에 주입하고 출처와 타임스탬프를 추적한다.
- `Patient`, `Encounter`, `Image`, `AIInference`, `Finding` 등의 Neo4j 스키마 제약을 적용하고 LLM이 제안한 새 지식이 기존 그래프와 충돌하지 않도록 조정한다.
- 요청별 `idempotency_key`로 그래프 조회 결과를 캐시하고 온톨로지 업데이트 시 만료해 최신성과 지연을 균형 있게 유지한다.

## 오케스트레이션 & API
- 기존 메시지 기반 파이프라인(Redis Streams 등)을 유지하되 `fusion.prepare`, `graph.retrieve`, `fusion.decode` 단계를 명시적으로 추가한다.
- 외부 API에서 결합 모드 힌트, 그래프 조회 토글, 설명 수준(원문·요약)을 설정할 수 있게 한다.
- SSE/WebSocket 스트림으로 그래프 조회 결과와 폴백 여부를 포함한 단계별 진행 상황을 제공한다.

## 안정성 & 평가
- Cypher 호출 지연이 SLA를 초과하면 자동으로 캐시 결과로 폴백하는 헬스 체크를 구현한다.
- 레이트-퓨전, 미드-퓨전, 그래프 증강 응답을 정확도·환각률·가독성 지표로 비교하는 평가 메트릭을 수집한다.
- 요청 ID, 결합 모드, 실행된 그래프 쿼리, 재시도 횟수 등을 포함한 구조화 로그를 기록하고 모니터링 대시보드로 내보낸다.
- 결합 레이어, Cypher 조회 로직, 온톨로지 업서트를 단위·통합·엔드투엔드 테스트로 검증하고 재현성을 위해 결정적 시드를 사용한다.

## 개발자 경험
- 미드-퓨전 데모 실행, 비주얼 토큰 캐시 재생성, Neo4j 시드, 이벤트 재생을 위한 스크립트/Make 타깃을 제공한다.
- 데이터 플로 다이어그램, 결합 설정, 조회 프롬프트 등을 문서화하고 결합 깊이나 Cypher 템플릿을 튜닝하는 가이드를 제공한다.
- Docker Compose에 Neo4j, Redis, 워커, 평가 노트북을 포함하고 필수 시크릿 예시가 담긴 `.env` 샘플을 제공한다.
