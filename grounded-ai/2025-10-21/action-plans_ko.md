# 미드-퓨전 멀티모달 추론 액션 플랜

## 1단계 – 정렬 및 데이터 계약
- LLM 인코더와 VLM 백본 간 공유 잠재 공간을 정의하고, 미드-퓨전에 필요한 텐서 형태·정규화·토큰 예산을 문서화한다.
- 데이터 적재 스크립트를 보강해 이미지가 모달리티, 환자/내원 식별자, 그래프 조회 키와 함께 유입되도록 한다.
- FastAPI/Streamlit 스키마를 업데이트해 원본 이미지 참조와 사전 계산된 비주얼 토큰을 모두 전송 가능하게 한다.
- Neo4j 업서트를 강화해 `MERGE` 패턴과 SHA256 기반 아이덴포턴시로 그래프 일관성을 확보한다.

## 2단계 – 미드-퓨전 아키텍처 프로토타입
- VLM 비주얼 토큰을 LLM 은닉 차원으로 사영하는 공유 프로젝션 레이어를 구현해 다양한 레이어에서 결합할 수 있게 한다.
- 추론 서비스에 레이트/미드-퓨전을 비교할 수 있는 설정 스위치를 추가하고 주의 지도·중간 활성값을 로깅한다.
- 추론 워커가 이미지+프롬프트 배치를 처리해 미드-퓨전 스택을 통과시키고 텍스트/구조화 결과를 반환하도록 확장한다.
- 고정 시드에서 응답이 결정적으로 유지되고 레이트-퓨전 폴백이 정상 동작하는지 회귀 테스트를 추가한다.

## 3단계 – 그래프 통합 추론 루프
- 현재 LLM 은닉 상태(또는 디코딩 계획 토큰)를 기반으로 관련 환자·내원·과거 추론을 조회하는 Cypher 쿼리 빌더를 설계한다.
- 조회된 그래프 사실을 미드-퓨전 시퀀스에 키/값 메모리 혹은 게이트드 토큰으로 주입하고 출처를 추적한다.
- 동일 컨텍스트에 대한 반복 조회는 아이덴포턴시 키와 함께 캐시해 그래프 부하를 줄인다.
- LLM 제안과 조회한 그래프 정보를 비교해 불일치 시 업서트 이벤트를 발생시키도록 온톨로지 라이터를 보강한다.

## 4단계 – 평가, 가시성, 롤아웃
- 미드-퓨전, 레이트-퓨전, 그래프 증강 응답을 의료 시나리오에 대해 비교하는 평가 하네스를 구축하고 정확도·환각률을 측정한다.
- 결합 지연, Cypher 실행 시간, 그래프 캐시 적중률 등 단계별 메트릭을 계측해 로그/대시보드로 노출한다.
- CI 범위를 확장해 결합 레이어 단위 테스트, Cypher 조회 통합 테스트, 엔드투엔드 API 스모크 테스트를 포함한다.
- README, 아키텍처 다이어그램, 개발자 가이드를 갱신하고 미드-퓨전 데모/그래프 활성화 추론을 위한 Make 타깃을 제공한다.
