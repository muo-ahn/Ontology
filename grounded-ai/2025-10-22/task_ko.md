# 그래프 DB 모델링 실행 계획

## 1. 준비 사항
- 로컬 Neo4j 인스턴스를 기동한다(도커 또는 기존 Compose 스택).  
- 테스트 스위트 의존성(`pytest`, `neo4j` Python 드라이버, Docker CLI)을 확인한다.  
- 작업 브랜치 `feature/graphdb-modeling-2025-10-22`를 생성한다.

## 2. 작업 분해

### 작업 A – 스키마 작성
- 제약/인덱스에 대한 Cypher 파일(`schema/v1_1/constraints.cypher`)을 작성한다.  
- 노드/관계 생성 스크립트(`schema/v1_1/migrations_up.cypher`)를 정의한다.  
- 롤백 스크립트(`schema/v1_1/migrations_down.cypher`)를 추가한다.  
- 산출물: 버전별 스키마 스크립트 디렉터리.

### 작업 B – 시드 데이터 & 픽스처
- 시술, 확장 약물 필드, AI 추론 출처 컬럼을 포함하도록 CSV 픽스처를 수정한다.  
- `seed.cypher`를 개정해 새 노드/관계를 적재하고 `OntologyVersion`을 입력한다.  
- 로컬 Neo4j에 전체 시드를 실행해 정상 여부를 확인한다.

### 작업 C – 적재 서비스 업데이트
- Neo4j에 쓰기 수행하는 Python 서비스/워커를 수정한다.  
  - 출처 엣지와 버전 참조를 채운다.  
  - 새로운 제약과 정합하도록 아이덴포턴트 merge 로직을 조정한다.  
- 제약 위반 처리에 대한 로그를 추가한다.

### 작업 D – 검증 & 테스트
- Pytest 통합 테스트를 작성해 다음을 수행한다.  
  - Docker로 Neo4j 기동.  
  - 마이그레이션 적용.  
  - 샘플 픽스처 로드.  
  - 핵심 불변식(고아 노드 없음, 식별자 유일, 타임라인 정렬)을 검증한다.  
- 내원 타임라인, 추론 출처에 대한 스모크 쿼리를 테스트에 포함한다.

### 작업 E – 문서화
- 업데이트된 노드/관계를 반영한 아키텍처 다이어그램(draw.io/mermaid)을 작성한다.  
- 온보딩 노트와 예시 Cypher 쿼리를 정리한다.  
- 마이그레이션 워크플로(명령줄/Make 사용법, 검증 절차)를 문서화한다.

## 3. 일정(권장)
- **1일차**: 작업 A와 B(스키마 + 픽스처).  
- **2일차**: 작업 C(서비스 수정) 및 작업 D 착수.  
- **3일차**: 작업 D 마무리, 전체 검증, 작업 E 문서화 완료.  
- **버퍼**: 리뷰와 보완을 위한 1일.

## 4. 종료 기준
- 마이그레이션이 신규/기존 DB 모두에서 정상적으로 상향·하향 실행된다.  
- 통합 테스트가 CI에서 통과한다.  
- 문서가 게시되고 프로젝트 README에서 링크된다.  
- 이해관계자가 업데이트된 온톨로지 구조를 검토·승인한다.
