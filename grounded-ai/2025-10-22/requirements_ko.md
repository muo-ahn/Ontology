# 그래프 DB 모델링 개편 요구사항

## 목표
- Neo4j에 저장된 의료 온톨로지를 개선해 임상의 흐름을 정확히 반영하고, 멀티모달 추론과 데이터 품질 요구사항을 충족한다.
- 미드-퓨전 추론, 분석, 감사 등 다운스트림 시스템이 일관된 그래프 구조와 메타데이터에 의존할 수 있도록 한다.

## 기능 요구사항
1. **임상 영역 확장**  
   - 내원, 관찰, 진단, 시술, 약물, 영상, AI 추론을 명시적 시간 관계와 함께 모델링한다.  
   - 추론으로 생성된 지식에 대한 출처(어떤 모델이 생성했는지)를 표현한다.
2. **온톨로지 버전 관리**  
   - 스키마 개정 사항을 추적하고, 마이그레이션 기간 동안 다중 버전 공존을 허용한다.  
   - 각 노드/관계가 어떤 스키마 버전에 따른 것인지 나타내는 API 또는 메타데이터 필드를 제공한다.
3. **데이터 검증**  
   - 핵심 ID(patient_id, encounter_id 등)에 대한 유일성과 존재 제약을 적용한다.  
   - 가능하다면 임상 코드(ICD, LOINC, SNOMED)를 기준 용어집과 대조한다.

## 비기능 요구사항
1. **성능 & 확장성**  
   - 일반 조회(환자 타임라인, 내원 요약, 추론 계보) 지연을 150ms 이하로 유지한다.  
   - 전체 그래프 재적재가 필요 없도록 증분 적재를 지원한다.
2. **유지보수성**  
   - 스키마 업데이트용 마이그레이션 스크립트(상향/하향)와 변경 로그를 제공한다.  
   - 신규 기여자가 노드/관계 의미를 문서로 쉽게 이해할 수 있게 한다.
3. **관측 가능성**  
   - 제약 위반이나 온톨로지 불일치 발생 시 메트릭/로그를 기록한다.  
   - 감사 추적이 가능하도록 데이터 계보 메타데이터를 캡처한다.

## 도구 & 자동화
1. **스키마 정의**  
   - 버전 관리되는 Cypher 스키마 정의를 유지한다.  
   - 마이그레이션을 아이덴포턴트하게 적용할 CLI 또는 Make 타깃을 제공한다.
2. **테스트 하네스**  
   - Neo4j를 기동하고, 픽스처를 로드하고, 마이그레이션을 적용한 뒤 그래프 불변식을 검증하는 통합 테스트(pytest 등)를 제공한다.  
   - 핵심 Cypher 쿼리에 대해 속성 기반 테스트나 스냅샷 테스트를 포함한다.
3. **데이터 품질 점검**  
   - 고아 노드, 비일관적 타임라인 등 이상을 탐지하는 자동 점검(사전/사후 적재)을 구현한다.

## 문서 요구사항
- 개편된 엔티티·관계 모델을 반영한 아키텍처 다이어그램을 업데이트한다.  
- 온톨로지를 안전하게 확장하는 방법을 설명하는 온보딩 문서를 작성한다.  
- 주요 사용 사례(타임라인, 코호트 추출, 추론 계보)에 대한 예시 쿼리를 제공한다.
